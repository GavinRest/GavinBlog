<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.61">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" type="image/png" sizes="16x16" href="/images/icons/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png"><link rel="manifest" href="/manifest.webmanifest"><meta name="application-name" content="VuePress"><meta name="apple-mobile-web-app-title" content="VuePress"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png"><link rel="mask-icon" href="/images/icons/safari-pinned-tab.svg" color="#3eaf7c"><meta name="msapplication-TileColor" content="#3eaf7c"><meta name="theme-color" content="#3eaf7c"><title>4.9 已建立连接的TCP，收到SYN会发生什么？</title><meta name="description" content="">
    <link rel="preload" href="/assets/style-d2355f92.css" as="style"><link rel="stylesheet" href="/assets/style-d2355f92.css">
    <link rel="modulepreload" href="/assets/app-9ffe8b05.js"><link rel="modulepreload" href="/assets/framework-5866ffd3.js"><link rel="modulepreload" href="/assets/challenge_ack.html-30f81c13.js"><link rel="modulepreload" href="/assets/challenge_ack.html-4cdbdb55.js"><link rel="prefetch" href="/assets/index.html-5d252c12.js" as="script"><link rel="prefetch" href="/assets/index.html-e9f86481.js" as="script"><link rel="prefetch" href="/assets/index.html-d94ed453.js" as="script"><link rel="prefetch" href="/assets/how_os_deal_network_package.html-5192b095.js" as="script"><link rel="prefetch" href="/assets/index.html-5d19e242.js" as="script"><link rel="prefetch" href="/assets/tcp_ip_model.html-06cbf026.js" as="script"><link rel="prefetch" href="/assets/what_happen_url.html-1763d200.js" as="script"><link rel="prefetch" href="/assets/http2.html-880edb25.js" as="script"><link rel="prefetch" href="/assets/http3.html-c84c57fa.js" as="script"><link rel="prefetch" href="/assets/http_interview.html-5ff2d6ef.js" as="script"><link rel="prefetch" href="/assets/http_optimize.html-fbabb7e8.js" as="script"><link rel="prefetch" href="/assets/https_ecdhe.html-64cbad4e.js" as="script"><link rel="prefetch" href="/assets/https_optimize.html-15af1dbe.js" as="script"><link rel="prefetch" href="/assets/https_rsa.html-f381123c.js" as="script"><link rel="prefetch" href="/assets/index.html-60571c29.js" as="script"><link rel="prefetch" href="/assets/isn_deff.html-b49e4853.js" as="script"><link rel="prefetch" href="/assets/out_of_order_fin.html-d721ed57.js" as="script"><link rel="prefetch" href="/assets/index.html-bda46135.js" as="script"><link rel="prefetch" href="/assets/syn_drop.html-a5479723.js" as="script"><link rel="prefetch" href="/assets/tcp_down_and_crash.html-1f3074b6.js" as="script"><link rel="prefetch" href="/assets/tcp_feature.html-16ed45ab.js" as="script"><link rel="prefetch" href="/assets/tcp_http_keepalive.html-72c89347.js" as="script"><link rel="prefetch" href="/assets/tcp_interview.html-f2c0a596.js" as="script"><link rel="prefetch" href="/assets/tcp_optimize.html-0eb7dc50.js" as="script"><link rel="prefetch" href="/assets/tcp_queue.html-8f4053d8.js" as="script"><link rel="prefetch" href="/assets/tcp_stream.html-65b26076.js" as="script"><link rel="prefetch" href="/assets/tcp_tcpdump.html-f25bf83f.js" as="script"><link rel="prefetch" href="/assets/tcp_tls.html-a5ed8bf0.js" as="script"><link rel="prefetch" href="/assets/tcp_tw_reuse_close.html-81027644.js" as="script"><link rel="prefetch" href="/assets/tcp_unplug_the_network_cable.html-baf64c6e.js" as="script"><link rel="prefetch" href="/assets/time_wait_recv_syn.html-e41a6a3c.js" as="script"><link rel="prefetch" href="/assets/ip_base.html-d51b3a67.js" as="script"><link rel="prefetch" href="/assets/ping.html-71059d67.js" as="script"><link rel="prefetch" href="/assets/draw.html-25ff0631.js" as="script"><link rel="prefetch" href="/assets/learn_network.html-9cc814e9.js" as="script"><link rel="prefetch" href="/assets/index.html-7fd4d25f.js" as="script"><link rel="prefetch" href="/assets/AWK使用.html-985cd04b.js" as="script"><link rel="prefetch" href="/assets/index.html-0cb96c7f.js" as="script"><link rel="prefetch" href="/assets/test.html-76a85405.js" as="script"><link rel="prefetch" href="/assets/test2.html-f4757387.js" as="script"><link rel="prefetch" href="/assets/基础命令.html-8932b8b1.js" as="script"><link rel="prefetch" href="/assets/index.html-51713cca.js" as="script"><link rel="prefetch" href="/assets/test1.html-9a4033b8.js" as="script"><link rel="prefetch" href="/assets/computer.html-96a9bfcf.js" as="script"><link rel="prefetch" href="/assets/index.html-2d945316.js" as="script"><link rel="prefetch" href="/assets/index.html-3d6e3014.js" as="script"><link rel="prefetch" href="/assets/wireshark_analysis.html-b3b03596.js" as="script"><link rel="prefetch" href="/assets/wireshark_basics.html-16ba56ea.js" as="script"><link rel="prefetch" href="/assets/wireshark_conversations.html-42faf5dd.js" as="script"><link rel="prefetch" href="/assets/wireshark_filter.html-648e90f4.js" as="script"><link rel="prefetch" href="/assets/wireshark_introduction.html-7c32e457.js" as="script"><link rel="prefetch" href="/assets/wireshark_io_graph.html-fda76a15.js" as="script"><link rel="prefetch" href="/assets/wireshark_nic_promiscuous.html-27636ef3.js" as="script"><link rel="prefetch" href="/assets/wireshark_remote_capture.html-85a186a7.js" as="script"><link rel="prefetch" href="/assets/wireshark_rtt.html-d41c9ec9.js" as="script"><link rel="prefetch" href="/assets/wireshark_tls.html-50a2bdaa.js" as="script"><link rel="prefetch" href="/assets/index.html-7963cff1.js" as="script"><link rel="prefetch" href="/assets/arp.html-fc9ebc97.js" as="script"><link rel="prefetch" href="/assets/ethernet_encapsulation.html-b9b58d1f.js" as="script"><link rel="prefetch" href="/assets/hsrp.html-65df2949.js" as="script"><link rel="prefetch" href="/assets/lacp.html-e68cc0d3.js" as="script"><link rel="prefetch" href="/assets/mtu.html-c6a33d01.js" as="script"><link rel="prefetch" href="/assets/protocol_model.html-ce746a68.js" as="script"><link rel="prefetch" href="/assets/bgp_introduction.html-aa141f65.js" as="script"><link rel="prefetch" href="/assets/eigrp_introduction.html-b56a3bc6.js" as="script"><link rel="prefetch" href="/assets/icmp_type_code.html-87a6efa9.js" as="script"><link rel="prefetch" href="/assets/ip_fragment.html-b43196f8.js" as="script"><link rel="prefetch" href="/assets/ip_header.html-26a2882b.js" as="script"><link rel="prefetch" href="/assets/ip_protocol.html-d0b52fcb.js" as="script"><link rel="prefetch" href="/assets/nat_introduction.html-fb1aae2f.js" as="script"><link rel="prefetch" href="/assets/ospf_area.html-61d31865.js" as="script"><link rel="prefetch" href="/assets/ospf_dijkstra.html-289bfe67.js" as="script"><link rel="prefetch" href="/assets/ospf_introduction.html-8dcdf02d.js" as="script"><link rel="prefetch" href="/assets/ospf_lsa.html-51ea593e.js" as="script"><link rel="prefetch" href="/assets/ospf_neighbor.html-5f8a8551.js" as="script"><link rel="prefetch" href="/assets/routing.html-10fa5890.js" as="script"><link rel="prefetch" href="/assets/http.html-670277e5.js" as="script"><link rel="prefetch" href="/assets/https.html-626ebc3e.js" as="script"><link rel="prefetch" href="/assets/tcp_flow-control.html-0b5df3c3.js" as="script"><link rel="prefetch" href="/assets/tcp_four-way-wavehand.html-5bf65220.js" as="script"><link rel="prefetch" href="/assets/tcp_header.html-2266a4f0.js" as="script"><link rel="prefetch" href="/assets/tcp_mss.html-eda36ade.js" as="script"><link rel="prefetch" href="/assets/tcp_protocol.html-f89e8f25.js" as="script"><link rel="prefetch" href="/assets/tcp_queue.html-b625e0e7.js" as="script"><link rel="prefetch" href="/assets/tcp_reset.html-0484cee9.js" as="script"><link rel="prefetch" href="/assets/tcp_retransmission.html-a88c2019.js" as="script"><link rel="prefetch" href="/assets/tcp_sliding-window.html-6e5665ec.js" as="script"><link rel="prefetch" href="/assets/tcp_slow_start.html-946acd8f.js" as="script"><link rel="prefetch" href="/assets/tcp_three-way-handshake.html-8a0f696e.js" as="script"><link rel="prefetch" href="/assets/tcp_time-wait.html-bf14aed2.js" as="script"><link rel="prefetch" href="/assets/udp_header.html-058e38bb.js" as="script"><link rel="prefetch" href="/assets/udp_protocol.html-0b20db8d.js" as="script"><link rel="prefetch" href="/assets/404.html-60b35caa.js" as="script"><link rel="prefetch" href="/assets/index.html-b4fb1533.js" as="script"><link rel="prefetch" href="/assets/index.html-f6554b98.js" as="script"><link rel="prefetch" href="/assets/index.html-29a576b0.js" as="script"><link rel="prefetch" href="/assets/how_os_deal_network_package.html-3c5ce5c4.js" as="script"><link rel="prefetch" href="/assets/index.html-c1f04f6d.js" as="script"><link rel="prefetch" href="/assets/tcp_ip_model.html-acd3a592.js" as="script"><link rel="prefetch" href="/assets/what_happen_url.html-0cf69b6b.js" as="script"><link rel="prefetch" href="/assets/http2.html-11ff579e.js" as="script"><link rel="prefetch" href="/assets/http3.html-d1694c9f.js" as="script"><link rel="prefetch" href="/assets/http_interview.html-df1cd129.js" as="script"><link rel="prefetch" href="/assets/http_optimize.html-a9df186d.js" as="script"><link rel="prefetch" href="/assets/https_ecdhe.html-90996f6b.js" as="script"><link rel="prefetch" href="/assets/https_optimize.html-a984fde0.js" as="script"><link rel="prefetch" href="/assets/https_rsa.html-87cc6bf0.js" as="script"><link rel="prefetch" href="/assets/index.html-8ba395ca.js" as="script"><link rel="prefetch" href="/assets/isn_deff.html-f1ff2def.js" as="script"><link rel="prefetch" href="/assets/out_of_order_fin.html-b4d71826.js" as="script"><link rel="prefetch" href="/assets/index.html-4bfb83b0.js" as="script"><link rel="prefetch" href="/assets/syn_drop.html-ece30534.js" as="script"><link rel="prefetch" href="/assets/tcp_down_and_crash.html-1e4fba7d.js" as="script"><link rel="prefetch" href="/assets/tcp_feature.html-f3b247ec.js" as="script"><link rel="prefetch" href="/assets/tcp_http_keepalive.html-dc17277d.js" as="script"><link rel="prefetch" href="/assets/tcp_interview.html-8ad1fe16.js" as="script"><link rel="prefetch" href="/assets/tcp_optimize.html-41cbaba0.js" as="script"><link rel="prefetch" href="/assets/tcp_queue.html-4e3915b4.js" as="script"><link rel="prefetch" href="/assets/tcp_stream.html-52ac9055.js" as="script"><link rel="prefetch" href="/assets/tcp_tcpdump.html-7836d156.js" as="script"><link rel="prefetch" href="/assets/tcp_tls.html-84e480ba.js" as="script"><link rel="prefetch" href="/assets/tcp_tw_reuse_close.html-6f6f9147.js" as="script"><link rel="prefetch" href="/assets/tcp_unplug_the_network_cable.html-78ac2a87.js" as="script"><link rel="prefetch" href="/assets/time_wait_recv_syn.html-48588e74.js" as="script"><link rel="prefetch" href="/assets/ip_base.html-dde19717.js" as="script"><link rel="prefetch" href="/assets/ping.html-41b4316a.js" as="script"><link rel="prefetch" href="/assets/draw.html-7c61b2e3.js" as="script"><link rel="prefetch" href="/assets/learn_network.html-daf04769.js" as="script"><link rel="prefetch" href="/assets/index.html-36551456.js" as="script"><link rel="prefetch" href="/assets/AWK使用.html-dec9bcae.js" as="script"><link rel="prefetch" href="/assets/index.html-9de56ed3.js" as="script"><link rel="prefetch" href="/assets/test.html-d8c9ac2f.js" as="script"><link rel="prefetch" href="/assets/test2.html-03ccc3c7.js" as="script"><link rel="prefetch" href="/assets/基础命令.html-248522a9.js" as="script"><link rel="prefetch" href="/assets/index.html-c79ac5c4.js" as="script"><link rel="prefetch" href="/assets/test1.html-2c5597c4.js" as="script"><link rel="prefetch" href="/assets/computer.html-7c337333.js" as="script"><link rel="prefetch" href="/assets/index.html-329e0e5b.js" as="script"><link rel="prefetch" href="/assets/index.html-79d2188d.js" as="script"><link rel="prefetch" href="/assets/wireshark_analysis.html-633fc59f.js" as="script"><link rel="prefetch" href="/assets/wireshark_basics.html-c104a64e.js" as="script"><link rel="prefetch" href="/assets/wireshark_conversations.html-ce0a2598.js" as="script"><link rel="prefetch" href="/assets/wireshark_filter.html-a1ea1309.js" as="script"><link rel="prefetch" href="/assets/wireshark_introduction.html-32999a14.js" as="script"><link rel="prefetch" href="/assets/wireshark_io_graph.html-a769cec9.js" as="script"><link rel="prefetch" href="/assets/wireshark_nic_promiscuous.html-2322bfb7.js" as="script"><link rel="prefetch" href="/assets/wireshark_remote_capture.html-b8e706d7.js" as="script"><link rel="prefetch" href="/assets/wireshark_rtt.html-e360cf21.js" as="script"><link rel="prefetch" href="/assets/wireshark_tls.html-033f385e.js" as="script"><link rel="prefetch" href="/assets/index.html-970c3b69.js" as="script"><link rel="prefetch" href="/assets/arp.html-9cd6c048.js" as="script"><link rel="prefetch" href="/assets/ethernet_encapsulation.html-6257c183.js" as="script"><link rel="prefetch" href="/assets/hsrp.html-af108101.js" as="script"><link rel="prefetch" href="/assets/lacp.html-cbc1c027.js" as="script"><link rel="prefetch" href="/assets/mtu.html-f79b16df.js" as="script"><link rel="prefetch" href="/assets/protocol_model.html-a3be2283.js" as="script"><link rel="prefetch" href="/assets/bgp_introduction.html-f8925854.js" as="script"><link rel="prefetch" href="/assets/eigrp_introduction.html-9469d1e8.js" as="script"><link rel="prefetch" href="/assets/icmp_type_code.html-b84a67ba.js" as="script"><link rel="prefetch" href="/assets/ip_fragment.html-2e9bc390.js" as="script"><link rel="prefetch" href="/assets/ip_header.html-24334093.js" as="script"><link rel="prefetch" href="/assets/ip_protocol.html-faa0dd5b.js" as="script"><link rel="prefetch" href="/assets/nat_introduction.html-8d858860.js" as="script"><link rel="prefetch" href="/assets/ospf_area.html-ad40edeb.js" as="script"><link rel="prefetch" href="/assets/ospf_dijkstra.html-9ae2a168.js" as="script"><link rel="prefetch" href="/assets/ospf_introduction.html-b9cd434d.js" as="script"><link rel="prefetch" href="/assets/ospf_lsa.html-176e20f6.js" as="script"><link rel="prefetch" href="/assets/ospf_neighbor.html-6a37992e.js" as="script"><link rel="prefetch" href="/assets/routing.html-cf21c728.js" as="script"><link rel="prefetch" href="/assets/http.html-524c16ae.js" as="script"><link rel="prefetch" href="/assets/https.html-407e0bbb.js" as="script"><link rel="prefetch" href="/assets/tcp_flow-control.html-edc5a7e9.js" as="script"><link rel="prefetch" href="/assets/tcp_four-way-wavehand.html-4a3f9df8.js" as="script"><link rel="prefetch" href="/assets/tcp_header.html-7fdf8f91.js" as="script"><link rel="prefetch" href="/assets/tcp_mss.html-6a8b9447.js" as="script"><link rel="prefetch" href="/assets/tcp_protocol.html-04ee4779.js" as="script"><link rel="prefetch" href="/assets/tcp_queue.html-1b00b4ad.js" as="script"><link rel="prefetch" href="/assets/tcp_reset.html-2972fd21.js" as="script"><link rel="prefetch" href="/assets/tcp_retransmission.html-4ef311c7.js" as="script"><link rel="prefetch" href="/assets/tcp_sliding-window.html-1419cb88.js" as="script"><link rel="prefetch" href="/assets/tcp_slow_start.html-7f2fa183.js" as="script"><link rel="prefetch" href="/assets/tcp_three-way-handshake.html-30059105.js" as="script"><link rel="prefetch" href="/assets/tcp_time-wait.html-b769e5cf.js" as="script"><link rel="prefetch" href="/assets/udp_header.html-31fb1dff.js" as="script"><link rel="prefetch" href="/assets/udp_protocol.html-610e6e9d.js" as="script"><link rel="prefetch" href="/assets/404.html-87d54bd8.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container no-sidebar"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/images/hero.png" alt><!--v-if--></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/nt/wireshark" class="" aria-label="网络抓包"><!--[--><!--]--> 网络抓包 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/nt/tcpip" class="" aria-label="TCP/IP协议栈"><!--[--><!--]--> TCP/IP协议栈 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="切换颜色模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/nt/wireshark" class="" aria-label="网络抓包"><!--[--><!--]--> 网络抓包 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/nt/tcpip" class="" aria-label="TCP/IP协议栈"><!--[--><!--]--> TCP/IP协议栈 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="_4-9-已建立连接的tcp-收到syn会发生什么" tabindex="-1"><a class="header-anchor" href="#_4-9-已建立连接的tcp-收到syn会发生什么" aria-hidden="true">#</a> 4.9 已建立连接的TCP，收到SYN会发生什么？</h1><p>大家好，我是小林。</p><p>昨晚有位读者问了我这么个问题：</p><p><img src="https://img-blog.csdnimg.cn/ea1c6e0165f04232ab02046132e63d0f.jpg?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bCP5p6XY29kaW5n,size_16,color_FFFFFF,t_70,g_se,x_16" alt=""></p><p>大概意思是，一个已经建立的 TCP 连接，客户端中途宕机了，而服务端此时也没有数据要发送，一直处于 establish 状态，客户端恢复后，向服务端建立连接，此时服务端会怎么处理？</p><p>看过我的图解网络的读者都知道，TCP 连接是由「四元组」唯一确认的。</p><p>然后这个场景中，客户端的IP、服务端IP、目的端口并没有变化，所以这个问题关键要看客户端发送的 SYN 报文中的源端口是否和上一次连接的源端口相同。</p><p><strong>1. 客户端的 SYN 报文里的端口号与历史连接不相同</strong></p><p>如果客户端恢复后发送的 SYN 报文中的源端口号跟上一次连接的源端口号不一样，此时服务端会认为是新的连接要建立，于是就会通过三次握手来建立新的连接。</p><p>那旧连接里处于 establish 状态的服务端最后会怎么样呢？</p><p>如果服务端发送了数据包给客户端，由于客户端的连接已经被关闭了，此时客户的内核就会回 RST 报文，服务端收到后就会释放连接。</p><p>如果服务端一直没有发送数据包给客户端，在超过一段时间后， TCP 保活机制就会启动，检测到客户端没有存活后，接着服务端就会释放掉该连接。</p><p><strong>2. 客户端的 SYN 报文里的端口号与历史连接相同</strong></p><p>如果客户端恢复后，发送的 SYN 报文中的源端口号跟上一次连接的源端口号一样，也就是处于 establish 状态的服务端收到了这个 SYN 报文。</p><p>大家觉得服务端此时会做什么处理呢？</p><ul><li>丢掉 SYN 报文？</li><li>回复 RST 报文？</li><li>回复 ACK 报文？</li></ul><p>刚开始我看到这个问题的时候，也是没有思路的，因为之前没关注过，然后这个问题不能靠猜，所以我就看了 RFC 规范和看了 Linux 内核源码，最终知道了答案。</p><p>我不卖关子，先直接说答案。</p><p><img src="https://img-blog.csdnimg.cn/ac087152e9d94fddb8468696c65b11b0.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bCP5p6XY29kaW5n,size_20,color_FFFFFF,t_70,g_se,x_16" alt=""></p><p><strong>处于 establish 状态的服务端如果收到了客户端的 SYN 报文（注意此时的 SYN 报文其实是乱序的，因为 SYN 报文的初始化序列号其实是一个随机数），会回复一个携带了正确序列号和确认号的 ACK 报文，这个 ACK 被称之为 Challenge ACK。</strong></p><p><strong>接着，客户端收到这个 Challenge ACK，发现序列号并不是自己期望收到的，于是就会回 RST 报文，服务端收到后，就会释放掉该连接。</strong></p><h2 id="rfc-文档解释" tabindex="-1"><a class="header-anchor" href="#rfc-文档解释" aria-hidden="true">#</a> RFC 文档解释</h2><p>rfc793 文档里的第 34 页里，有说到这个例子。</p><p><img src="https://img-blog.csdnimg.cn/873ad18443c040708c415bab6592ae41.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bCP5p6XY29kaW5n,size_14,color_FFFFFF,t_70,g_se,x_16" alt=""> 原文的解释我也贴出来给大家看看。</p><ul><li>When the SYN arrives at line 3, TCP B, being in a synchronized state, and the incoming segment outside the window, responds with an acknowledgment indicating what sequence it next expects to hear (ACK 100).</li><li>TCP A sees that this segment does not acknowledge anything it sent and, being unsynchronized, sends a reset (RST) because it has detected a half-open connection.</li><li>TCP B aborts at line 5.</li><li>TCP A willcontinue to try to establish the connection;</li></ul><p>我就不瞎翻译了，意思和我在前面用中文说的解释差不多。</p><h2 id="源码分析" tabindex="-1"><a class="header-anchor" href="#源码分析" aria-hidden="true">#</a> 源码分析</h2><p>处于 establish 状态的服务端如果收到了客户端的 SYN 报文时，内核会调用这些函数：</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code>tcp_v4_rcv
  <span class="token operator">-&gt;</span> tcp_v4_do_rcv
    <span class="token operator">-&gt;</span> tcp_rcv_established
      <span class="token operator">-&gt;</span> tcp_validate_incoming
        <span class="token operator">-&gt;</span> tcp_send_ack
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们只关注 tcp_validate_incoming 函数是怎么处理 SYN 报文的，精简后的代码如下：</p><p><img src="https://img-blog.csdnimg.cn/780bc02c8fa940c0a320a5916b216c21.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bCP5p6XY29kaW5n,size_20,color_FFFFFF,t_70,g_se,x_16" alt=""> 从上面的代码实现可以看到，处于 establish 状态的服务端，在收到报文后，首先会判断序列号是否在窗口内，如果不在，则看看 RST 标记有没有被设置，如果有就会丢掉。然后如果没有 RST 标志，就会判断是否有 SYN 标记，如果有 SYN 标记就会跳转到 syn_challenge 标签，然后执行 tcp_send_challenge_ack 函数。</p><p>tcp_send_challenge_ack 函数里就会调用 tcp_send_ack 函数来回复一个携带了正确序列号和确认号的 ACK 报文。</p><h2 id="如何关闭一个-tcp-连接" tabindex="-1"><a class="header-anchor" href="#如何关闭一个-tcp-连接" aria-hidden="true">#</a> 如何关闭一个 TCP 连接？</h2><p>这里问题大家这么一个问题，如何关闭一个 TCP 连接？</p><p>可能大家第一反应是「杀掉进程」不就行了吗？</p><p>是的，这个是最粗暴的方式，杀掉客户端进程和服务端进程影响的范围会有所不同：</p><ul><li>在客户端杀掉进程的话，就会发送 FIN 报文，来断开这个客户端进程与服务端建立的所有 TCP 连接，这种方式影响范围只有这个客户端进程所建立的连接，而其他客户端或进程不会受影响。</li><li>而在服务端杀掉进程影响就大了，此时所有的 TCP 连接都会被关闭，服务端无法继续提供访问服务。</li></ul><p>所以，关闭进程的方式并不可取，最好的方式要精细到关闭某一条 TCP 连接。</p><p>有的小伙伴可能会说，伪造一个四元组相同的 RST 报文不就行了？</p><p>这个思路很好，但是不要忘了还有个序列号的问题，你伪造的 RST 报文的序列号一定能被对方接受吗？</p><p>如果 RST 报文的序列号不能落在对方的滑动窗口内，这个 RST 报文会被对方丢弃的，就达不到关闭的连接的效果。</p><p>所以，<strong>要伪造一个能关闭 TCP 连接的 RST 报文，必须同时满足「四元组相同」和「序列号正好落在对方的滑动窗口内」这两个条件。</strong></p><p>直接伪造符合预期的序列号是比较困难，因为如果一个正在传输数据的 TCP 连接，滑动窗口时刻都在变化，因此很难刚好伪造一个刚好落在对方滑动窗口内的序列号的 RST 报文。</p><p>办法还是有的，<strong>我们可以伪造一个四元组相同的 SYN 报文，来拿到“合法”的序列号！</strong></p><p>正如我们最开始学到的，如果处于 establish 状态的服务端，收到四元组相同的 SYN 报文后，<strong>会回复一个 Challenge ACK，这个 ACK 报文里的「确认号」，正好是服务端下一次想要接收的序列号，说白了，就是可以通过这一步拿到服务端下一次预期接收的序列号。</strong></p><p><strong>然后用这个确认号作为 RST 报文的序列号，发送给服务端，此时服务端会认为这个 RST 报文里的序列号是合法的，于是就会释放连接！</strong></p><p>在 Linux 上有个叫 killcx 的工具，就是基于上面这样的方式实现的，它会主动发送 SYN 包获取 SEQ/ACK 号，然后利用 SEQ/ACK 号伪造两个 RST 报文分别发给客户端和服务端，这样双方的 TCP 连接都会被释放，这种方式活跃和非活跃的 TCP 连接都可以杀掉。</p><p>使用方式也很简单，只需指明客户端的 IP 和端口号。</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token punctuation">.</span><span class="token operator">/</span>killcx <span class="token operator">&lt;</span>IP地址<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>端口号<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>killcx 工具的工作原理，如下图。</p><p><img src="https://img-blog.csdnimg.cn/95592346a9a747819cd27741a660213c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bCP5p6XY29kaW5n,size_20,color_FFFFFF,t_70,g_se,x_16" alt=""></p><p>它伪造客户端发送 SYN 报文，服务端收到后就会回复一个携带了正确「序列号和确认号」的 ACK 报文（Challenge ACK），然后就可以利用这个 ACK 报文里面的信息，伪造两个 RST 报文：</p><ul><li>用 Challenge ACK 里的确认号伪造 RST 报文发送给服务端，服务端收到 RST 报文后就会释放连接。</li><li>用 Challenge ACK 里的序列号伪造 RST 报文发送给客户端，客户端收到 RST 也会释放连接。</li></ul><p>正是通过这样的方式，成功将一个 TCP 连接关闭了！</p><p>这里给大家贴一个使用 killcx 工具关闭连接的抓包图，大家多看看序列号和确认号的变化。</p><p><img src="https://img-blog.csdnimg.cn/71cbefee5ab741018386b6a37f492614.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bCP5p6XY29kaW5n,size_17,color_FFFFFF,t_70,g_se,x_16" alt=""> 所以，以后抓包中，如果莫名奇妙出现一个 SYN 包，有可能对方接下来想要对你发起的 RST 攻击，直接将你的 TCP 连接断开！</p><p>怎么样，很巧妙吧！</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 996414666@qq.com">Seven</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app-9ffe8b05.js" defer></script>
  </body>
</html>
